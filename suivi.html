<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Suivi Mwaka Pizza</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --blue: #3498db; --orange: #f39c12; --green: #2ecc71; --dark: #0b0b0b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark); color: #fff; text-align: center; padding: 20px; margin: 0; }
        
        .logo { margin-bottom: 20px; width: 140px; height: 140px; object-fit: contain; }
        
        .status-box { background: #1a1a1a; border-radius: 25px; padding: 30px; margin: 10px auto; max-width: 450px; border-top: 6px solid var(--blue); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        #status-label { text-transform: uppercase; letter-spacing: 3px; color: #777; font-size: 0.9em; margin-bottom: 10px; font-weight: bold; }
        #msg { font-size: 1.4em; font-weight: 900; margin: 15px 0; color: #fff; line-height: 1.3; }
        
        .step-icon { font-size: 70px; margin-bottom: 20px; color: var(--blue); text-shadow: 0 0 25px rgba(52, 152, 219, 0.5); }
        
        /* Section Drive */
        #drive-area { margin-top: 30px; padding: 20px; background: #222; border-radius: 20px; display: none; border: 1px solid #333; }
        .btn-drive { background: var(--orange); color: #000; border: none; padding: 18px 25px; border-radius: 50px; font-weight: 900; font-size: 1.1em; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; transition: 0.3s; }
        .btn-drive.active { background: var(--green); color: #fff; }
        
        .pulse { animation: pulse-orange 2s infinite; }
        @keyframes pulse-orange { 0% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(243, 156, 18, 0); } 100% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0); } }

        .location-info { font-size: 0.85em; color: #888; margin-top: 15px; line-height: 1.4; }
        .info-speciale { background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 10px; font-size: 0.95em; margin-top: 20px; border: 1px dashed var(--blue); color: var(--blue); font-weight: bold; }
        
        .error-msg { color: #e74c3c; font-size: 0.9em; margin-top: 20px; display: none; }
    </style>
</head>
<body>
    
    <img src="https://crisfayah.github.io/mwakapizza-app-tel/logo.png" class="logo" alt="Mwaka Pizza">
    
    <div class="status-box">
        <div id="status-label">INITIALISATION</div>
        <div id="icon-container">
            <i id="icon" class="fas fa-circle-notch fa-spin step-icon"></i>
        </div>
        <div id="msg">Connexion au restaurant...</div>
        
        <div id="special-msg" class="info-speciale" style="display:none;"></div>

        <div id="drive-area">
            <button id="btn-depart" class="btn-drive pulse" onclick="signalerDepart()">
                <i class="fas fa-car"></i> JE PARS CHERCHER MA PIZZA
            </button>
            <div id="gps-status" class="location-info">En signalant votre d√©part, l'√©quipe pourra anticiper votre arriv√©e pour une pizza toujours chaude.</div>
        </div>

        <div id="error-display" class="error-msg"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyCxyNbWyEAVot0sDzBzUdbqp4tQ2jBWMS0", authDomain: "mwakaphone-e8c5b.firebaseapp.com", projectId: "mwakaphone-e8c5b", storageBucket: "mwakaphone-e8c5b.firebasestorage.app", messagingSenderId: "258049374795", appId: "1:258049374795:web:bc7863ce2f86d8a6c8abce" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('id');

        // S√©curit√© : Si pas d'ID, on affiche une aide
        if (!orderId) {
            document.getElementById('msg').innerText = "Lien de suivi invalide.";
            document.getElementById('status-label').innerText = "ERREUR";
            document.getElementById('icon').className = "fas fa-search step-icon";
            document.getElementById('error-display').style.display = "block";
            document.getElementById('error-display').innerText = "Il manque l'identifiant de commande dans l'adresse (URL).";
        } else {
            console.log("Tentative de suivi pour l'ID :", orderId);
            
            // Timeout de diagnostic
            const diagnosticTimeout = setTimeout(() => {
                document.getElementById('error-display').style.display = "block";
                document.getElementById('error-display').innerText = "La recherche prend du temps... V√©rifiez que la commande existe toujours dans le KDS.";
            }, 6000);

            // √âcoute temps r√©el
            db.collection("commandes").doc(orderId).onSnapshot((doc) => {
                clearTimeout(diagnosticTimeout);
                document.getElementById('error-display').style.display = "none";

                if (doc.exists) {
                    const d = doc.data();
                    const status = (d.status || "").toLowerCase();
                    const msgDiv = document.getElementById('msg');
                    const icon = document.getElementById('icon');
                    const label = document.getElementById('status-label');
                    const driveArea = document.getElementById('drive-area');
                    const specDiv = document.getElementById('special-msg');

                    // 1. Mise √† jour visuelle du statut
                    if (status === "en_attente") {
                        label.innerText = "COMMANDE RE√áUE";
                        msgDiv.innerText = "Mwaka a bien re√ßu votre commande ! Elle va √™tre pr√©par√©e.";
                        icon.className = "fas fa-receipt step-icon";
                    } else if (status === "production") {
                        label.innerText = "PR√âPARATION";
                        msgDiv.innerText = "Le pizzaiolo garnit vos pizzas... üë©‚Äçüç≥";
                        icon.className = "fas fa-utensils step-icon";
                    } else if (status === "cuisson") {
                        label.innerText = "AU FOUR";
                        msgDiv.innerText = "Vos pizzas sont au four ! √áa croustille... üî•";
                        icon.className = "fas fa-fire step-icon";
                    } else if (status === "termine" || status === "prete") {
                        label.innerText = "C'EST PR√äT !";
                        msgDiv.innerText = "VOTRE COMMANDE EST DISPONIBLE ! ‚úÖ";
                        icon.className = "fas fa-check-circle step-icon";
                        icon.style.color = "#2ecc71";
                        icon.style.textShadow = "0 0 25px rgba(46, 204, 113, 0.5)";
                    }

                    // 2. Gestion du Drive
                    const isLivr = (d.type || "").toLowerCase().includes("livraison");
                    if (!isLivr && status !== "termine" && status !== "prete") {
                        driveArea.style.display = "block";
                    } else {
                        driveArea.style.display = "none";
                    }

                    // 3. Message de la cuisine (D√©lai / Info)
                    if (d.clientMsg || d.delay) {
                        specDiv.style.display = "block";
                        specDiv.innerText = d.clientMsg || ("Pr√©vu dans : " + d.delay);
                    } else {
                        specDiv.style.display = "none";
                    }
                } else {
                    document.getElementById('msg').innerText = "Commande introuvable.";
                    document.getElementById('icon').className = "fas fa-times-circle step-icon";
                }
            }, (err) => {
                console.error("Erreur Firebase:", err);
                document.getElementById('msg').innerText = "Erreur de connexion.";
            });
        }

        function signalerDepart() {
            const btn = document.getElementById('btn-depart');
            const gpsStatus = document.getElementById('gps-status');

            if (!navigator.geolocation) {
                alert("Votre appareil ne supporte pas la g√©olocalisation.");
                return;
            }

            btn.innerHTML = '<i class="fas fa-sync fa-spin"></i> ACTIVATION GPS...';
            
            navigator.geolocation.watchPosition((pos) => {
                db.collection("commandes").doc(orderId).update({
                    clientLocation: { lat: pos.coords.latitude, lng: pos.coords.longitude },
                    isEnRoute: true,
                    lastGpsUpdate: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    btn.classList.remove('pulse');
                    btn.classList.add('active');
                    btn.innerHTML = '<i class="fas fa-map-marker-alt"></i> VOUS √äTES EN ROUTE !';
                    gpsStatus.innerText = "Votre position est partag√©e. Mwaka pr√©pare votre arriv√©e.";
                });
            }, (err) => {
                gpsStatus.innerText = "Veuillez autoriser l'acc√®s GPS pour utiliser le Drive.";
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ACC√àS REFUS√â';
            }, { enableHighAccuracy: true });
        }
    </script>
</body>
</html>
