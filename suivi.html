<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Suivi Mwaka Pizza - Drive & Live</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --blue: #3498db; --orange: #f39c12; --green: #2ecc71; --dark: #0b0b0b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark); color: #fff; text-align: center; padding: 20px; margin: 0; }
        
        .logo { margin-bottom: 20px; border-radius: 50%; border: 2px solid var(--blue); }
        
        .status-box { background: #1a1a1a; border-radius: 25px; padding: 30px; margin: 10px auto; max-width: 500px; border-top: 6px solid var(--blue); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        #status-label { text-transform: uppercase; letter-spacing: 3px; color: #777; font-size: 0.9em; margin-bottom: 10px; }
        #msg { font-size: 1.6em; font-weight: 900; margin: 15px 0; color: #fff; }
        
        .step-icon { font-size: 60px; margin-bottom: 20px; color: var(--blue); text-shadow: 0 0 20px rgba(52, 152, 219, 0.4); }
        
        /* Bouton Drive */
        .drive-section { margin-top: 30px; padding: 20px; background: #222; border-radius: 20px; display: none; border: 1px solid #333; }
        .btn-drive { background: var(--orange); color: #000; border: none; padding: 15px 25px; border-radius: 50px; font-weight: 900; font-size: 1.1em; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; transition: 0.3s; }
        .btn-drive.active { background: var(--green); color: #fff; }
        .pulse { animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(243, 156, 18, 0); } 100% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0); } }

        .location-info { font-size: 0.8em; color: #888; margin-top: 10px; }
        .info-speciale { background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 10px; font-size: 0.9em; margin-top: 20px; border: 1px dashed var(--blue); }
    </style>
</head>
<body>
    <img src="https://moniresto.com/mwakapizza/img/mwaka-pizza-logo-1615545224.jpg" width="100" class="logo">
    
    <div class="status-box">
        <div id="status-label">Chargement...</div>
        <div id="icon-container">
            <i id="icon" class="fas fa-spinner fa-spin step-icon"></i>
        </div>
        <div id="msg">R√©cup√©ration de votre commande...</div>
        
        <div id="special-msg" class="info-speciale" style="display:none;"></div>

        <div id="drive-area" class="drive-section">
            <button id="btn-depart" class="btn-drive pulse" onclick="signalerDepart()">
                <i class="fas fa-car"></i> JE PARS CHERCHER MA PIZZA
            </button>
            <div id="gps-status" class="location-info">En signalant votre d√©part, la cuisine pr√©parera votre sac au moment id√©al.</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyCxyNbWyEAVot0sDzBzUdbqp4tQ2jBWMS0", authDomain: "mwakaphone-e8c5b.firebaseapp.com", projectId: "mwakaphone-e8c5b", storageBucket: "mwakaphone-e8c5b.firebasestorage.app", messagingSenderId: "258049374795", appId: "1:258049374795:web:bc7863ce2f86d8a6c8abce" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('id');
        let watchId = null;

        if (orderId) {
            db.collection("commandes").doc(orderId).onSnapshot((doc) => {
                if (doc.exists) {
                    const d = doc.data();
                    const msgDiv = document.getElementById('msg');
                    const icon = document.getElementById('icon');
                    const label = document.getElementById('status-label');
                    const driveArea = document.getElementById('drive-area');

                    // Synchronisation des statuts avec cuisine.html
                    if (d.status === "en_attente") {
                        label.innerText = "Re√ßue";
                        msgDiv.innerText = "Mwaka a bien re√ßu votre commande !";
                        icon.className = "fas fa-clock step-icon";
                    } else if (d.status === "production") {
                        label.innerText = "En pr√©paration";
                        msgDiv.innerText = "Le pizzaiolo pr√©pare vos pizzas... üë©‚Äçüç≥";
                        icon.className = "fas fa-utensils step-icon";
                    } else if (d.status === "cuisson") {
                        label.innerText = "Au four";
                        msgDiv.innerText = "C'est en train de dorer au four ! üî•";
                        icon.className = "fas fa-fire step-icon";
                    } else if (d.status === "termine") {
                        label.innerText = "Pr√™te !";
                        msgDiv.innerText = "C'EST PR√äT ! R√âCUP√âREZ-LA ! ‚úÖ";
                        icon.className = "fas fa-check-circle step-icon";
                        icon.style.color = "#2ecc71";
                    }

                    // Afficher le bouton Drive si c'est de l'emport√©/drive
                    if (d.type !== "LIVRAISON" && d.status !== "termine") {
                        driveArea.style.display = "block";
                    } else {
                        driveArea.style.display = "none";
                    }

                    // Message sp√©cial (ex: d√©lai chaud)
                    if (d.clientMsg) {
                        const spec = document.getElementById('special-msg');
                        spec.style.display = "block";
                        spec.innerText = d.clientMsg;
                    }
                }
            });
        }

        function signalerDepart() {
            const btn = document.getElementById('btn-depart');
            const gpsStatus = document.getElementById('gps-status');

            if (!navigator.geolocation) {
                alert("La g√©olocalisation n'est pas support√©e par votre navigateur.");
                return;
            }

            btn.innerHTML = '<i class="fas fa-sync fa-spin"></i> ACTIVATION GPS...';
            
            // On commence √† surveiller la position
            watchId = navigator.geolocation.watchPosition((position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                // Mise √† jour Firebase
                db.collection("commandes").doc(orderId).update({
                    clientLocation: { lat: lat, lng: lng },
                    isEnRoute: true,
                    lastGpsUpdate: firebase.firestore.FieldValue.serverTimestamp()
                });

                btn.classList.remove('pulse');
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-map-marker-alt"></i> VOUS √äTES EN ROUTE !';
                gpsStatus.innerText = "Position partag√©e. La cuisine est pr√©venue de votre arriv√©e.";

            }, (error) => {
                console.error(error);
                gpsStatus.innerText = "Erreur GPS : Veuillez autoriser la localisation.";
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> GPS D√âSACTIV√â';
            }, {
                enableHighAccuracy: true,
                maximumAge: 30000,
                timeout: 27000
            });
        }
    </script>
</body>
</html>
