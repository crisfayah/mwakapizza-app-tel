<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Suivi Mwaka Pizza</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --blue: #3498db; --orange: #f39c12; --green: #2ecc71; --dark: #0b0b0b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark); color: #fff; text-align: center; padding: 20px; margin: 0; }
        
        .logo { margin-bottom: 20px; width: 120px; height: 120px; object-fit: contain; }
        
        .status-box { background: #1a1a1a; border-radius: 25px; padding: 30px; margin: 10px auto; max-width: 500px; border-top: 6px solid var(--blue); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        #status-label { text-transform: uppercase; letter-spacing: 3px; color: #777; font-size: 0.9em; margin-bottom: 10px; }
        #msg { font-size: 1.4em; font-weight: 900; margin: 15px 0; color: #fff; line-height: 1.3; }
        
        .step-icon { font-size: 60px; margin-bottom: 20px; color: var(--blue); text-shadow: 0 0 20px rgba(52, 152, 219, 0.4); }
        
        .drive-section { margin-top: 30px; padding: 20px; background: #222; border-radius: 20px; display: none; border: 1px solid #333; }
        .btn-drive { background: var(--orange); color: #000; border: none; padding: 15px 25px; border-radius: 50px; font-weight: 900; font-size: 1.1em; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; transition: 0.3s; }
        .btn-drive.active { background: var(--green); color: #fff; }
        
        .pulse { animation: pulse-orange 2s infinite; }
        @keyframes pulse-orange { 0% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(243, 156, 18, 0); } 100% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0); } }

        .location-info { font-size: 0.8em; color: #888; margin-top: 12px; }
        .info-speciale { background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 10px; font-size: 0.9em; margin-top: 20px; border: 1px dashed var(--blue); color: var(--blue); }
    </style>
</head>
<body>
    <img src="https://crisfayah.github.io/mwakapizza-app-tel/logo.png" class="logo" alt="Mwaka Pizza">
    
    <div class="status-box">
        <div id="status-label">CHARGEMENT...</div>
        <div id="icon-container">
            <i id="icon" class="fas fa-circle-notch fa-spin step-icon"></i>
        </div>
        <div id="msg">R√©cup√©ration de votre commande...</div>
        
        <div id="special-msg" class="info-speciale" style="display:none;"></div>

        <div id="drive-area" class="drive-section">
            <button id="btn-depart" class="btn-drive pulse" onclick="signalerDepart()">
                <i class="fas fa-car"></i> JE PARS CHERCHER MA PIZZA
            </button>
            <div id="gps-status" class="location-info">Signalez votre d√©part pour que Mwaka pr√©pare votre sac √† votre arriv√©e.</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyCxyNbWyEAVot0sDzBzUdbqp4tQ2jBWMS0", authDomain: "mwakaphone-e8c5b.firebaseapp.com", projectId: "mwakaphone-e8c5b", storageBucket: "mwakaphone-e8c5b.firebasestorage.app", messagingSenderId: "258049374795", appId: "1:258049374795:web:bc7863ce2f86d8a6c8abce" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('id');

        if (!orderId) {
            document.getElementById('msg').innerText = "Erreur : ID de commande manquant dans le lien.";
            document.getElementById('icon').className = "fas fa-exclamation-triangle step-icon";
        } else {
            // √âcoute en temps r√©el de la commande
            db.collection("commandes").doc(orderId).onSnapshot((doc) => {
                if (doc.exists) {
                    const d = doc.data();
                    const msgDiv = document.getElementById('msg');
                    const icon = document.getElementById('icon');
                    const label = document.getElementById('status-label');
                    const driveArea = document.getElementById('drive-area');
                    const specDiv = document.getElementById('special-msg');

                    // Mise √† jour de l'affichage selon le statut
                    const status = d.status ? d.status.toLowerCase() : "";

                    if (status === "en_attente") {
                        label.innerText = "RE√áUE";
                        msgDiv.innerText = "Mwaka a bien re√ßu votre commande ! Elle va √™tre valid√©e.";
                        icon.className = "fas fa-clock step-icon";
                    } else if (status === "production") {
                        label.innerText = "PR√âPARATION";
                        msgDiv.innerText = "Le pizzaiolo pr√©pare vos pizzas avec amour... üë©‚Äçüç≥";
                        icon.className = "fas fa-utensils step-icon";
                    } else if (status === "cuisson") {
                        label.innerText = "AU FOUR";
                        msgDiv.innerText = "Vos pizzas sont au four ! √áa dore doucement... üî•";
                        icon.className = "fas fa-fire step-icon";
                    } else if (status === "termine" || status === "prete") {
                        label.innerText = "PR√äTE !";
                        msgDiv.innerText = "C'EST PR√äT ! VOUS POUVEZ R√âCUP√âRER VOTRE COMMANDE ! ‚úÖ";
                        icon.className = "fas fa-check-circle step-icon";
                        icon.style.color = "#2ecc71";
                    } else {
                        label.innerText = "EN COURS";
                        msgDiv.innerText = "Nous traitons votre commande...";
                        icon.className = "fas fa-sync fa-spin step-icon";
                    }

                    // Bouton Drive : visible si emport√© et non termin√©
                    const isLivr = (d.type || "").toLowerCase().includes("livraison");
                    if (!isLivr && status !== "termine" && status !== "prete") {
                        driveArea.style.display = "block";
                    } else {
                        driveArea.style.display = "none";
                    }

                    // Message sp√©cial (d√©lai ou message direct de la cuisine)
                    if (d.clientMsg || d.delay) {
                        specDiv.style.display = "block";
                        specDiv.innerText = d.clientMsg || ("Estimation : " + d.delay);
                    } else {
                        specDiv.style.display = "none";
                    }
                } else {
                    document.getElementById('msg').innerText = "Commande introuvable. V√©rifiez votre lien.";
                    document.getElementById('icon').className = "fas fa-search step-icon";
                }
            }, (error) => {
                console.error("Erreur Firebase:", error);
                document.getElementById('msg').innerText = "Erreur de connexion au serveur.";
            });
        }

        function signalerDepart() {
            const btn = document.getElementById('btn-depart');
            const gpsStatus = document.getElementById('gps-status');

            if (!navigator.geolocation) {
                alert("GPS non support√©.");
                return;
            }

            btn.innerHTML = '<i class="fas fa-sync fa-spin"></i> ACTIVATION...';
            
            navigator.geolocation.watchPosition((position) => {
                db.collection("commandes").doc(orderId).update({
                    clientLocation: { lat: position.coords.latitude, lng: position.coords.longitude },
                    isEnRoute: true,
                    lastGpsUpdate: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    btn.classList.remove('pulse');
                    btn.classList.add('active');
                    btn.innerHTML = '<i class="fas fa-map-marker-alt"></i> VOUS √äTES EN ROUTE !';
                    gpsStatus.innerText = "Position partag√©e. Mwaka pr√©pare votre arriv√©e.";
                });
            }, (err) => {
                gpsStatus.innerText = "Veuillez autoriser la localisation pour le Drive.";
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> GPS REQUIS';
            }, { enableHighAccuracy: true });
        }
    </script>
</body>
</html>
