<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mwaka Pizza - CUISINE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: sans-serif; background: #0b0b0b; color: #fff; margin:0; }
        .tabs { display: flex; background: #1a1a1a; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .tab-btn { flex: 1; padding: 20px; border: none; background: none; color: #555; font-size: 18px; font-weight: bold; cursor: pointer; border-bottom: 4px solid transparent; }
        .tab-btn.active { color: #2ecc71; border-bottom-color: #2ecc71; background: #111; }
        .tab-btn.active.tab-encours { color: #e74c3c; border-bottom-color: #e74c3c; }
        .orders-list { display: flex; flex-direction: column; gap: 15px; padding: 15px; max-width: 900px; margin: 0 auto; }
        
        /* CARTES */
        .order-card { background: #1a1a1a; border-radius: 15px; padding: 20px; border-left: 15px solid #2ecc71; box-shadow: 0 4px 15px rgba(0,0,0,0.3); position: relative; }
        
        /* COULEUR BLEUE POUR LE WEB */
        .order-card.is-web { border-left-color: #3498db ! deprivation; }
        
        .client-header { font-size: 26px; font-weight: 900; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .type-tag { font-size: 14px; background: #333; padding: 6px 12px; border-radius: 8px; text-transform: uppercase; }
        
        /* BLOC LIVRAISON */
        .delivery-info { background: #2c3e50; padding: 12px; border-radius: 10px; margin-bottom: 15px; border-left: 5px solid #3498db; font-size: 1.2em; line-height: 1.4; }
        
        .items-area { background: #252525; padding: 15px; border-radius: 10px; font-size: 1.6em; border: 1px solid #333; margin-bottom: 15px; }
        .pizza-line { border-bottom: 1px solid #3d3d3d; padding: 10px 0; }
        
        .actions { display: flex; gap: 12px; }
        .btn { flex: 1; padding: 18px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-done { background: #27ae60; color: white; }
        .delay-menu { display: none; width: 100%; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="tabs">
        <button class="tab-btn active tab-encours" id="tabEncours" onclick="switchTab('en_attente')">EN COURS ‚è≥</button>
        <button class="tab-btn" id="tabTermine" onclick="switchTab('termine')">TERMINE ‚úÖ</button>
    </div>
    <div id="ordersContainer" class="orders-list"></div>
    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2855/2855-preview.mp3" preload="auto"></audio>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyCxyNbWyEAVot0sDzBzUdbqp4tQ2jBWMS0", authDomain: "mwakaphone-e8c5b.firebaseapp.com", projectId: "mwakaphone-e8c5b", storageBucket: "mwakaphone-e8c5b.firebasestorage.app", messagingSenderId: "258049374795", appId: "1:258049374795:web:bc7863ce2f86d8a6c8abce" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let currentView = 'en_attente';

        function startAlert() { const s = document.getElementById('notifSound'); s.loop = true; s.play().catch(e => {}); }
        function stopAlert() { const s = document.getElementById('notifSound'); s.pause(); s.currentTime = 0; }

        function switchTab(status) { currentView = status; loadOrders(); }

        function isTodayMQ(timestamp) {
            if(!timestamp) return true;
            const date = timestamp.toDate();
            const mqDate = new Intl.DateTimeFormat('fr-CA', { timeZone: 'America/Martinique', year: 'numeric', month: '2-digit', day: '2-digit' }).format(date);
            const todayMQ = new Intl.DateTimeFormat('fr-CA', { timeZone: 'America/Martinique', year: 'numeric', month: '2-digit', day: '2-digit' }).format(new Date());
            return mqDate === todayMQ;
        }

        function loadOrders() {
            db.collection("commandes").where("status", "==", currentView).onSnapshot((snapshot) => {
                const container = document.getElementById('ordersContainer');
                container.innerHTML = "";
                let dailyOrders = [];
                snapshot.forEach(doc => { if(isTodayMQ(doc.data().createdAt)) dailyOrders.push({id: doc.id, ...doc.data()}); });
                dailyOrders.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                dailyOrders.forEach((o) => {
                    const isWeb = o.source === "PRESTASHOP";
                    const isDelivery = o.type === "LIVRAISON";
                    const card = document.createElement('div');
                    card.className = `order-card ${isWeb ? 'is-web' : ''}`;
                    
                    card.innerHTML = `
                        <div class="client-header">
                            <span>${o.clientName}</span>
                            <span class="type-tag">${o.type}</span>
                        </div>
                        
                        ${isDelivery ? `
                            <div class="delivery-info">
                                üìç ${o.address}<br>
                                üìû <b>${o.phone}</b>
                            </div>
                        ` : ''}

                        <div class="items-area">
                            ${o.items ? o.items.map(p => `<div class="pizza-line"><strong>${p.qty}x ${p.name.toUpperCase()}</strong></div>`).join('') : ''}
                        </div>

                        <div class="actions">
                            ${currentView === 'en_attente' ? `<button class="btn btn-done" onclick="toggleDelayMenu('${o.id}')">ACCEPTER</button>` : `<button class="btn" onclick="updateStatus('${o.id}', 'en_attente')">REMETTRE üîÑ</button>`}
                        </div>
                        <div id="delay-${o.id}" class="delay-menu">
                            <button style="background:#2ecc71; color:white; border:none; padding:15px; border-radius:8px;" onclick="updateStatus('${o.id}', 'termine', 'RAPIDE')">RAPIDE</button>
                            <button style="background:#f39c12; color:white; border:none; padding:15px; border-radius:8px;" onclick="updateStatus('${o.id}', 'termine', '15 min')">15 min</button>
                            <button style="background:#e74c3c; color:white; border:none; padding:15px; border-radius:8px;" onclick="updateStatus('${o.id}', 'termine', 'CHAUD !')">CHAUD !</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            });
        }

        function toggleDelayMenu(id) {
            const m = document.getElementById(`delay-${id}`);
            m.style.display = m.style.display === 'grid' ? 'none' : 'grid';
        }

        function updateStatus(id, s, d = null) {
            stopAlert();
            const up = { status: s }; if(d) up.delay = d;
            db.collection("commandes").doc(id).update(up).then(() => { if(s === 'termine') switchTab('termine'); });
        }
        window.onload = loadOrders;
    </script>
</body>
</html>
