<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mwaka Pizza - CUISINE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest-cuisine.json">
    <style>
        body { font-family: sans-serif; background: #0b0b0b; color: #fff; padding: 0; margin:0; overflow-x: hidden; }
        
        /* Onglets */
        .tabs { display: flex; background: #1a1a1a; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .tab-btn { flex: 1; padding: 20px; border: none; background: none; color: #555; font-size: 18px; font-weight: bold; cursor: pointer; border-bottom: 4px solid transparent; transition: 0.3s; }
        .tab-btn.active { color: #2ecc71; border-bottom-color: #2ecc71; background: #111; }
        .tab-btn.active.tab-encours { color: #e74c3c; border-bottom-color: #e74c3c; }

        /* Liste des commandes */
        .orders-list { display: flex; flex-direction: column; gap: 15px; padding: 15px; max-width: 1000px; margin: 0 auto; }
        
        .order-card { background: #1a1a1a; border-radius: 15px; padding: 20px; border-left: 15px solid #2ecc71; position: relative; animation: slideIn 0.3s ease-out; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .order-card.livraison { border-left-color: #e74c3c; }
        
        .time { position: absolute; top: 20px; right: 20px; color: #888; font-weight: bold; font-size: 1.1em; }
        .client-header { font-size: 26px; font-weight: 900; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; }
        .type-tag { font-size: 14px; background: #333; padding: 5px 12px; border-radius: 6px; text-transform: uppercase; color: #fff; }
        
        /* Zone Produits */
        .items-area { background: #252525; padding: 15px; border-radius: 10px; margin: 15px 0; font-size: 1.4em; border: 1px solid #333; }
        .pizza-line { border-bottom: 1px solid #3d3d3d; padding: 12px 0; }
        .pizza-line:last-child { border: none; }
        .notes { color: #ff9800; font-size: 0.85em; font-style: italic; margin-top: 5px; }
        .supps { color: #2ecc71; font-size: 0.75em; font-weight: bold; display: block; margin-top: 3px; }

        /* Infos Livraison */
        .delivery-box { background: #3a1616; padding: 15px; border-radius: 10px; border: 2px dashed #e74c3c; margin-top: 15px; font-size: 1.2em; line-height: 1.4; }
        
        /* Boutons */
        .actions { display: flex; gap: 12px; margin-top: 20px; }
        .btn { flex: 1; padding: 18px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 18px; transition: 0.2s; }
        .btn-done { background: #2ecc71; color: white; }
        .btn-print { background: #444; color: white; width: 100px; flex: none; font-size: 24px; }
        .btn-restore { background: #555; color: white; }

        /* Alerte Hors-Ligne */
        #offlineOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(231, 76, 60, 0.98); z-index:10000; flex-direction:column; justify-content:center; align-items:center; color:white; text-align:center; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="offlineOverlay">
        <h1 style="font-size:70px; margin-bottom:20px;">‚ö†Ô∏è CONNEXION PERDUE ‚ö†Ô∏è</h1>
        <p style="font-size:30px;">LA CUISINE NE RE√áOIT PLUS RIEN !</p>
        <p style="font-size:20px; margin-top:30px; opacity:0.8;">V√©rifiez le Wi-Fi de la pizzeria.</p>
    </div>

    <div class="tabs">
        <button class="tab-btn active tab-encours" id="tabEncours" onclick="switchTab('en_attente')">EN COURS ‚è≥</button>
        <button class="tab-btn" id="tabTermine" onclick="switchTab('termine')">TERMINE ‚úÖ</button>
    </div>

    <div id="ordersContainer" class="orders-list">
        <p style="text-align:center; color:#444; margin-top:100px;">Connexion au cloud Mwaka...</p>
    </div>

    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2855/2855-preview.mp3" preload="auto"></audio>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        // CONFIGURATION FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCxyNbWyEAVot0sDzBzUdbqp4tQ2jBWMS0",
            authDomain: "mwakaphone-e8c5b.firebaseapp.com",
            projectId: "mwakaphone-e8c5b",
            storageBucket: "mwakaphone-e8c5b.firebasestorage.app",
            messagingSenderId: "258049374795",
            appId: "1:258049374795:web:bc7863ce2f86d8a6c8abce"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentView = 'en_attente';
        let lastOrderCount = -1;
        let allOrders = {};

        // --- GESTION DU SON ---
        function startAlert() {
            const sound = document.getElementById('notifSound');
            sound.loop = true;
            sound.play().catch(e => console.log("Attente clic utilisateur"));
        }

        function stopAlert() {
            const sound = document.getElementById('notifSound');
            sound.pause();
            sound.currentTime = 0;
        }

        // --- GESTION INTERNET ---
        function checkConnection() {
            const overlay = document.getElementById('offlineOverlay');
            if (!navigator.onLine) {
                overlay.style.display = 'flex';
                speakAlert("Attention ! Connexion perdue.");
            } else {
                overlay.style.display = 'none';
                window.speechSynthesis.cancel();
            }
        }

        function speakAlert(msg) {
            if (!window.speechSynthesis.speaking && !navigator.onLine) {
                const u = new SpeechSynthesisUtterance(msg);
                u.lang = 'fr-FR';
                window.speechSynthesis.speak(u);
                setTimeout(() => speakAlert(msg), 10000);
            }
        }
        window.addEventListener('offline', checkConnection);
        window.addEventListener('online', checkConnection);

        // --- LOGIQUE COMMANDES ---
        function switchTab(status) {
            stopAlert();
            currentView = status;
            document.getElementById('tabEncours').classList.toggle('active', status === 'en_attente');
            document.getElementById('tabTermine').classList.toggle('active', status === 'termine');
            loadOrders();
        }

        function loadOrders() {
            db.collection("commandes")
              .where("status", "==", currentView)
              .orderBy("createdAt", "desc")
              .onSnapshot((snapshot) => {
                const container = document.getElementById('ordersContainer');
                container.innerHTML = "";

                if (currentView === 'en_attente' && lastOrderCount !== -1 && snapshot.size > lastOrderCount) {
                    startAlert();
                }
                lastOrderCount = snapshot.size;

                if (snapshot.empty) {
                    container.innerHTML = `<p style="text-align:center; margin-top:100px; color:#444;">Aucune commande.</p>`;
                    return;
                }

                snapshot.forEach((doc) => {
                    const o = doc.data();
                    allOrders[doc.id] = o;
                    const date = o.createdAt ? o.createdAt.toDate() : new Date();
                    const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    
                    const card = document.createElement('div');
                    card.className = `order-card ${o.type === 'Livraison' ? 'livraison' : ''}`;
                    
                    card.innerHTML = `
                        <div class="time">${timeStr}</div>
                        <div class="client-header">${o.clientName} <span class="type-tag">${o.type}</span></div>
                        
                        <div class="items-area">
                            ${o.items ? o.items.map(p => `
                                <div class="pizza-line">
                                    <strong>${p.qty}x ${p.name.toUpperCase()}</strong>
                                    ${p.supps && p.supps.length > 0 ? `<span class="supps">+ ${p.supps.join(', ')}</span>` : ''}
                                    ${p.notes ? `<div class="notes">${p.notes}</div>` : ''}
                                </div>
                            `).join('') : ''}

                            ${o.desserts && o.desserts.length > 0 ? `
                                <div style="color:#9b59b6; padding-top:10px; border-top:1px dashed #555; margin-top:10px;">
                                    DESSERTS : ${o.desserts.map(d => `${d.qty}x ${d.name}`).join(' | ')}
                                </div>
                            ` : ''}

                            ${o.drinks && o.drinks.length > 0 ? `
                                <div style="color:#3498db; padding-top:5px;">
                                    BOISSONS : ${o.drinks.map(dr => `${dr.qty}x ${dr.name}`).join(' | ')}
                                </div>
                            ` : ''}
                        </div>

                        ${o.type === 'Livraison' ? `
                            <div class="delivery-box">
                                üè† <strong>ADR :</strong> ${o.address} | üìû <strong>TEL :</strong> ${o.phone}<br>
                                üí≥ <strong>R√àGLEMENT :</strong> ${o.payment}
                            </div>
                        ` : ''}

                        <div class="actions">
                            <button class="btn btn-print" onclick="printToBluetooth('${doc.id}')">üñ®Ô∏è</button>
                            ${currentView === 'en_attente' 
                                ? `<button class="btn btn-done" onclick="updateStatus('${doc.id}', 'termine')">PR√äT ‚úÖ</button>`
                                : `<button class="btn btn-restore" onclick="updateStatus('${doc.id}', 'en_attente')">REMETTRE üîÑ</button>`
                            }
                        </div>
                    `;
                    container.appendChild(card);
                });
            });
        }

        function updateStatus(id, newStatus) {
            stopAlert();
            db.collection("commandes").doc(id).update({ status: newStatus });
        }

        function printToBluetooth(orderId) {
            const o = allOrders[orderId];
            let t = "--------------------------------\n   MWAKA PIZZA - CUISINE\n--------------------------------\n";
            t += "CLIENT: " + o.clientName + " (" + o.type + ")\n";
            t += "--------------------------------\n";
            if(o.items) o.items.forEach(p => { t += p.qty + "x " + p.name.toUpperCase() + "\n"; });
            if(o.desserts) o.desserts.forEach(d => { t += d.qty + "x " + d.name + "\n"; });
            if(o.drinks) o.drinks.forEach(dr => { t += dr.qty + "
