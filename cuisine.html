<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mwaka Pizza - CUISINE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: sans-serif; background: #0b0b0b; color: #fff; margin:0; padding: 0; overflow-x: hidden; }
        .tabs { display: flex; background: #1a1a1a; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .tab-btn { flex: 1; padding: 20px; border: none; background: none; color: #555; font-size: 18px; font-weight: bold; cursor: pointer; border-bottom: 4px solid transparent; }
        /* Couleurs d'origine des onglets */
        .tab-btn.active.tab-encours { color: #e74c3c; border-bottom-color: #e74c3c; background: #111; }
        .tab-btn.active#tabTermine { color: #2ecc71; border-bottom-color: #2ecc71; background: #111; }
        
        .orders-list { display: flex; flex-direction: column; gap: 15px; padding: 15px; max-width: 900px; margin: 0 auto; }
        
        /* CARTES ET BORDURES */
        .order-card { background: #1a1a1a; border-radius: 15px; padding: 20px; border-left: 15px solid #2ecc71; position: relative; animation: slideIn 0.3s ease-out; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        
        /* Bordure Bleue si Source = PRESTASHOP */
        .order-card.is-web { border-left-color: #3498db !important; }
        /* Bordure Rouge si Livraison Manuelle */
        .order-card.livraison-manuelle { border-left-color: #e74c3c; }

        .client-header { font-size: 26px; font-weight: 900; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
        .type-tag { font-size: 14px; background: #333; padding: 5px 12px; border-radius: 6px; text-transform: uppercase; color: #fff; }
        
        /* BLOC INFOS LIVRAISON */
        .delivery-box { background: #1e272e; padding: 15px; border-radius: 10px; border: 1px solid #3498db; margin-bottom: 15px; font-size: 1.3em; line-height: 1.4; color: #3498db; }

        .items-area { background: #252525; padding: 15px; border-radius: 10px; margin: 15px 0; font-size: 1.6em; border: 1px solid #333; }
        .pizza-line { border-bottom: 1px solid #3d3d3d; padding: 12px 0; }
        .pizza-line:last-child { border: none; }

        /* BOUTONS D'ORIGINE */
        .actions { display: flex; gap: 12px; margin-top: 20px; }
        .btn { flex: 1; padding: 18px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-done { background: #27ae60; color: white; }
        .btn-print { background: #444; color: white; width: 80px; flex: none; font-size: 24px; }
        
        .delay-menu { display: none; width: 100%; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .btn-delay { padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; color: white; text-transform: uppercase; }
        .bg-rapide { background: #2ecc71; }
        .bg-15min { background: #f39c12; }
        .bg-chaud { background: #e74c3c; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="tabs">
        <button class="tab-btn active tab-encours" id="tabEncours" onclick="switchTab('en_attente')">EN COURS ‚è≥</button>
        <button class="tab-btn" id="tabTermine" onclick="switchTab('termine')">TERMINE ‚úÖ</button>
    </div>
    <div id="ordersContainer" class="orders-list"></div>
    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2855/2855-preview.mp3" preload="auto"></audio>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyCxyNbWyEAVot0sDzBzUdbqp4tQ2jBWMS0", authDomain: "mwakaphone-e8c5b.firebaseapp.com", projectId: "mwakaphone-e8c5b", storageBucket: "mwakaphone-e8c5b.firebasestorage.app", messagingSenderId: "258049374795", appId: "1:258049374795:web:bc7863ce2f86d8a6c8abce" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let currentView = 'en_attente';
        let lastOrderCount = -1;
        let allOrders = {};

        function startAlert() { const s = document.getElementById('notifSound'); s.loop = true; s.play().catch(e => {}); }
        function stopAlert() { const s = document.getElementById('notifSound'); s.pause(); s.currentTime = 0; }

        function switchTab(status) {
            stopAlert();
            currentView = status;
            document.getElementById('tabEncours').classList.toggle('active', status === 'en_attente');
            document.getElementById('tabTermine').classList.toggle('active', status === 'termine');
            loadOrders();
        }

        function isTodayMQ(timestamp) {
            if(!timestamp) return true;
            const date = timestamp.toDate();
            const mqDate = new Intl.DateTimeFormat('fr-CA', { timeZone: 'America/Martinique', year: 'numeric', month: '2-digit', day: '2-digit' }).format(date);
            const todayMQ = new Intl.DateTimeFormat('fr-CA', { timeZone: 'America/Martinique', year: 'numeric', month: '2-digit', day: '2-digit' }).format(new Date());
            return mqDate === todayMQ;
        }

        function loadOrders() {
            db.collection("commandes").where("status", "==", currentView).onSnapshot((snapshot) => {
                const container = document.getElementById('ordersContainer');
                container.innerHTML = "";
                let dailyOrders = [];
                snapshot.forEach(doc => { if(isTodayMQ(doc.data().createdAt)) dailyOrders.push({id: doc.id, ...doc.data()}); });
                
                if (currentView === 'en_attente' && lastOrderCount !== -1 && dailyOrders.length > lastOrderCount) startAlert();
                lastOrderCount = dailyOrders.length;
                dailyOrders.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                dailyOrders.forEach((o) => {
                    allOrders[o.id] = o;
                    // D√©tection Web ou Livraison
                    const isWeb = o.source === "PRESTASHOP";
                    const isLivraison = o.type === "LIVRAISON";
                    
                    const card = document.createElement('div');
                    // On applique la classe 'is-web' pour le bleu ou 'livraison-manuelle' pour le rouge
                    card.className = `order-card ${isWeb ? 'is-web' : ''} ${isLivraison && !isWeb ? 'livraison-manuelle' : ''}`;
                    
                    card.innerHTML = `
                        <div class="client-header">
                            <span>${o.clientName}</span>
                            <span class="type-tag">${o.type}</span>
                        </div>
                        
                        ${isLivraison && isWeb ? `
                            <div class="delivery-box">
                                üìç ${o.address || 'Adresse manquante'}<br>
                                üìû <b>${o.phone || 'Pas de num√©ro'}</b>
                            </div>
                        ` : ''}

                        <div class="items-area">
                            ${o.items ? o.items.map(p => `<div class="pizza-line"><strong>${p.qty}x ${p.name.toUpperCase()}</strong></div>`).join('') : ''}
                        </div>

                        <div class="actions">
                            <button class="btn btn-print" onclick="printToBluetooth('${o.id}')">üñ®Ô∏è</button>
                            ${currentView === 'en_attente' ? `<button class="btn btn-done" onclick="toggleDelayMenu('${o.id}')"><i class="fas fa-clock"></i> ACCEPTER</button>` : `<button class="btn btn-restore" onclick="updateStatus('${o.id}', 'en_attente')">REMETTRE üîÑ</button>`}
                        </div>
                        
                        <div id="delay-${o.id}" class="delay-menu">
                            <button class="btn-delay bg-rapide" onclick="updateStatus('${o.id}', 'termine', 'RAPIDE')">RAPIDE</button>
                            <button class="btn-delay bg-15min" onclick="updateStatus('${o.id}', 'termine', '15 min')">15 min</button>
                            <button class="btn-delay bg-chaud" onclick="updateStatus('${o.id}', 'termine', 'CHAUD !')">CHAUD !</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            });
        }

        function toggleDelayMenu(id) {
            const menu = document.getElementById(`delay-${id}`);
            const isVisible = menu.style.display === 'grid';
            document.querySelectorAll('.delay-menu').forEach(m => m.style.display = 'none');
            menu.style.display = isVisible ? 'none' : 'grid';
        }

        function updateStatus(id, newStatus, delay = null) {
            stopAlert();
            const data = { status: newStatus };
            if(delay) data.delay = delay;
            db.collection("commandes").doc(id).update(data).then(() => { if(newStatus === 'termine') switchTab('termine'); });
        }

        function printToBluetooth(orderId) {
            const o = allOrders[orderId];
            let text = "MWAKA PIZZA\n" + o.clientName + "\n----------------\n";
            if(o.items) o.items.forEach(p => { text += p.qty + "x " + p.name + "\n"; });
            if(o.type === "LIVRAISON") text += "----------------\nADR: " + o.address + "\nTEL: " + o.phone + "\n";
            const b64 = btoa(unescape(encodeURIComponent(text)));
            window.location.href = "intent:#Intent;scheme=rawbt;package=ru.a402d.rawbtprinter;S.base64=" + b64 + ";end;";
        }
        window.onload = loadOrders;
    </script>
</body>
</html>
