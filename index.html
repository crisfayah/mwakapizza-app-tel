<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mwaka Pizza - Commande</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: sans-serif; background: #000; color: #fff; padding-bottom: 40px; touch-action: manipulation; }
        .nav-tabs { display: flex; background: #1a1a1a; border-bottom: 3px solid #2d5f3f; position: sticky; top: 0; z-index: 1000; }
        .nav-btn { flex: 1; padding: 18px; border: none; background: none; color: #888; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .nav-btn.active { color: #fff; background: #2d5f3f; }
        .header { background: #1a1a1a; padding: 15px; text-align: center; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .section { display: none; }
        .section.active { display: block; }
        .type-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .type-btn { flex: 1; padding: 15px; border-radius: 12px; border: 2px solid #333; background: #222; color: #888; cursor: pointer; font-weight: bold; }
        .type-btn.selected { background: #e74c3c; color: white; border-color: #e74c3c; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #2d5f3f; font-weight: bold; font-size: 0.9em; text-transform: uppercase; }
        input, textarea, select { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid #333; background: #1a1a1a; color: white; font-size: 16px; }
        .order-item { background: #1a1a1a; border: 1px solid #333; padding: 15px; border-radius: 15px; margin-bottom: 12px; border-left: 6px solid #2d5f3f; position: relative; }
        .btn-add { width: 100%; padding: 15px; color: white; border: none; border-radius: 10px; cursor: pointer; margin: 8px 0; font-weight: bold; font-size: 16px; }
        .btn-pizza { background: #2d5f3f; }
        .btn-dessert { background: #9b59b6; }
        .btn-drink { background: #3498db; }
        .btn-submit { width: 100%; padding: 20px; background: #e74c3c; color: white; border: none; border-radius: 15px; font-size: 20px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .total-box { background: #1a1a1a; border: 2px solid #2d5f3f; padding: 15px; border-radius: 15px; text-align: center; margin-top: 20px; }
        .autocomplete-list { background: #222; border: 1px solid #444; max-height: 150px; overflow-y: auto; position: absolute; width: 100%; z-index: 10; border-radius: 0 0 10px 10px; }
        .autocomplete-item { padding: 12px; border-bottom: 1px solid #333; cursor: pointer; }
        .delete-btn { color: #e74c3c; background: none; border: none; font-size: 12px; font-weight: bold; padding: 10px 0; width: 100%; text-align: right; cursor: pointer; }
        .suivi-card { background: #1a1a1a; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .status-badge { padding: 5px 10px; border-radius: 6px; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="nav-tabs">
        <button class="nav-btn active" id="btn-commander" onclick="showSection('orderSection', this)">Commander</button>
        <button class="nav-btn" id="btn-suivi" onclick="showSection('suiviSection', this)">Suivi</button>
    </div>
    <div class="header"><h1>üçï Mwaka Pizza</h1></div>
    <div class="container">
        <div id="orderSection" class="section active">
            <div class="type-selector">
                <button type="button" class="type-btn" id="btnEmporter" onclick="setType('Emporter')">üè† Emporter</button>
                <button type="button" class="type-btn selected" id="btnLivraison" onclick="setType('Livraison')">üöó Livraison</button>
            </div>
            <form id="orderForm">
                <div class="form-group"><label>Nom & Pr√©nom</label><input type="text" id="clientName" required></div>
                <div id="livraisonInfo">
                    <div class="form-group"><label>T√©l√©phone</label><input type="tel" id="phone"></div>
                    <div class="form-group"><label>Adresse</label><textarea id="address" rows="2"></textarea></div>
                    <div class="form-group">
                        <label>Mode de r√®glement</label>
                        <select id="paymentMethod">
                            <option value="Esp√®ces">Esp√®ces</option>
                            <option value="Carte">Carte bancaire</option>
                            <option value="Ch√®que">Ch√®que</option>
                        </select>
                    </div>
                </div>
                <div id="pizzasList"></div>
                <button type="button" class="btn-add btn-pizza" onclick="addPizza()">‚ûï PIZZA</button>
                <div id="dessertsList"></div>
                <button type="button" class="btn-add btn-dessert" onclick="addDessert()">üç∞ DESSERT</button>
                <div id="drinksList"></div>
                <button type="button" class="btn-add btn-drink" onclick="addDrink()">ü•§ BOISSON</button>
                <div class="total-box"><div class="total-amount" id="totalDisplay">0.00 ‚Ç¨</div></div>
                <button type="submit" class="btn-submit" id="submitBtn">üöÄ ENVOYER EN CUISINE</button>
            </form>
        </div>
        <div id="suiviSection" class="section">
            <h2 style="margin-bottom: 15px; color: #2ecc71;">Commandes R√©centes</h2>
            <div id="suiviList"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script>
        const config = { apiKey: "AIzaSyCxyNbWyEAVot0sDzBzUdbqp4tQ2jBWMS0", authDomain: "mwakaphone-e8c5b.firebaseapp.com", projectId: "mwakaphone-e8c5b", storageBucket: "mwakaphone-e8c5b.firebasestorage.app", messagingSenderId: "258049374795", appId: "1:258049374795:web:bc7863ce2f86d8a6c8abce" };
        firebase.initializeApp(config); const db = firebase.firestore();

        let currentType = 'Livraison';
        let unsubscribeSuivi = null;

        // --- NAVIGATION ---
        function showSection(id, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            
            if(id === 'suiviSection') listenSuivi();
            else if(unsubscribeSuivi) { unsubscribeSuivi(); unsubscribeSuivi = null; }
        }

        // --- SUIVI (AVEC NETTOYAGE) ---
        function listenSuivi() {
            if(unsubscribeSuivi) unsubscribeSuivi();
            // On limite aux 15 derni√®res commandes pour √©viter le gel
            unsubscribeSuivi = db.collection("commandes")
                .orderBy("createdAt", "desc").limit(15)
                .onSnapshot((snap) => {
                    const list = document.getElementById('suiviList');
                    list.innerHTML = "";
                    snap.forEach(doc => {
                        const o = doc.data();
                        const div = document.createElement('div');
                        div.className = 'suivi-card';
                        const statusColor = o.status === 'en_attente' ? '#555' : '#2ecc71';
                        div.innerHTML = `<div><strong>${o.clientName}</strong></div><span class="status-badge" style="background:${statusColor}">${o.status === 'en_attente' ? 'Re√ßu' : 'Pr√™t'}</span>`;
                        list.appendChild(div);
                    });
                });
        }

        // --- DONN√âES ---
        const menuPizzas = [{n:'Maria', p:11}, {n:'Mama', p:13}, {n:'Ochan', p:14}, {n:'Mwaka Moon', p:15}];
        const menuDesserts = [{n:'Tiramisu', p:3.9}, {n:'Muffin', p:3.9}];
        const menuDrinks = [{n:'Coca 50cl', p:2.5}, {n:'Chanflor 50cl', p:2}];

        // --- FONCTIONS AJOUT ---
        function setType(t) { currentType = t; document.getElementById('btnEmporter').classList.toggle('selected', t==='Emporter'); document.getElementById('btnLivraison').classList.toggle('selected', t==='Livraison'); document.getElementById('livraisonInfo').style.display = t==='Livraison' ? 'block' : 'none'; }

        function addPizza() {
            const div = document.createElement('div'); div.className = 'order-item';
            div.innerHTML = `<div style="display:flex; gap:10px;"><select class="p-qty" onchange="calcTotal()">${[1,2,3,4,5].map(v=>`<option value="${v}">${v}</option>`).join('')}</select><div style="flex:1;position:relative"><input type="text" class="p-name" placeholder="Pizza..." required oninput="search(this)"><div class="autocomplete-list"></div></div></div><button type="button" class="delete-btn" onclick="this.parentElement.remove(); calcTotal()">üóëÔ∏è SUPPRIMER</button>`;
            document.getElementById('pizzasList').appendChild(div);
        }

        function addDessert() {
            const div = document.createElement('div'); div.className = 'order-item';
            div.innerHTML = `<div style="display:flex; gap:10px;"><select class="d-qty" onchange="calcTotal()">${[1,2,3].map(v=>`<option value="${v}">${v}</option>`).join('')}</select><select class="d-name" style="flex:1" onchange="calcTotal()"><option value="" data-price="0">-- Dessert --</option>${menuDesserts.map(d=>`<option value="${d.n}" data-price="${d.p}">${d.n}</option>`).join('')}</select></div><button type="button" class="delete-btn" onclick="this.parentElement.remove(); calcTotal()">üóëÔ∏è SUPPRIMER</button>`;
            document.getElementById('dessertsList').appendChild(div);
        }

        function addDrink() {
            const div = document.createElement('div'); div.className = 'order-item';
            div.innerHTML = `<div style="display:flex; gap:10px;"><select class="dr-qty" onchange="calcTotal()">${[1,2,3].map(v=>`<option value="${v}">${v}</option>`).join('')}</select><select class="dr-name" style="flex:1" onchange="calcTotal()"><option value="" data-price="0">-- Boisson --</option>${menuDrinks.map(d=>`<option value="${d.n}" data-price="${d.p}">${d.n}</option>`).join('')}</select></div><button type="button" class="delete-btn" onclick="this.parentElement.remove(); calcTotal()">üóëÔ∏è SUPPRIMER</button>`;
            document.getElementById('drinksList').appendChild(div);
        }

        function search(input) {
            const list = input.nextElementSibling; list.innerHTML = ''; const val = input.value.toLowerCase(); if(!val) return;
            menuPizzas.filter(m => m.n.toLowerCase().includes(val)).forEach(m => {
                const d = document.createElement('div'); d.className = 'autocomplete-item'; d.innerText = m.n;
                d.onclick = () => { input.value = m.n; input.dataset.price = m.p; list.innerHTML = ''; calcTotal(); };
                list.appendChild(d);
            });
        }

        function calcTotal() {
            let t = 0;
            document.querySelectorAll('.p-qty').forEach(q => { const p = q.nextElementSibling.querySelector('input'); t += parseInt(q.value) * parseFloat(p.dataset.price || 0); });
            document.querySelectorAll('.d-name').forEach(s => { t += parseInt(s.previousElementSibling.value) * parseFloat(s.options[s.selectedIndex].dataset.price || 0); });
            document.querySelectorAll('.dr-name').forEach(s => { t += parseInt(s.previousElementSibling.value) * parseFloat(s.options[s.selectedIndex].dataset.price || 0); });
            document.getElementById('totalDisplay').innerText = t.toFixed(2) + " ‚Ç¨"; return t;
        }

        // --- ENVOI ---
        document.getElementById('orderForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn'); btn.disabled = true; btn.innerText = "ENVOI...";

            const order = {
                clientName: document.getElementById('clientName').value,
                type: currentType.toUpperCase(), // Correction : "LIVRAISON"
                paymentMethod: document.getElementById('paymentMethod').value, // Correction : paymentMethod
                phone: document.getElementById('phone').value || '',
                address: document.getElementById('address').value || '',
                items: Array.from(document.querySelectorAll('#pizzasList .order-item')).map(p => ({ qty: p.querySelector('.p-qty').value, name: p.querySelector('.p-name').value })),
                desserts: Array.from(document.querySelectorAll('#dessertsList .order-item')).map(d => ({ qty: d.querySelector('.d-qty').value, name: d.querySelector('.d-name').value })),
                drinks: Array.from(document.querySelectorAll('#drinksList .order-item')).map(dr => ({ qty: dr.querySelector('.dr-qty').value, name: dr.querySelector('.dr-name').value })),
                status: 'en_attente',
                source: 'MANUEL',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try { await db.collection("commandes").add(order); location.reload(); }
            catch(err) { alert(err.message); btn.disabled = false; }
        };

        window.onload = () => { addPizza(); };
    </script>
</body>
</html>
